# 代码可读性与重构建议

本文件总结了当前实现中可读性一般/可重构的部分，并给出面向“可维护性与扩展性”的改进建议。列出的路径均以仓库相对路径表示。


**总体建议**

- 拆分超长函数，减少嵌套层级，提升单元职责清晰度；给关键中间变量补充类型注解与简短注释；统一命名风格（如张量形状相关统一用 `*_ids`, `*_mask`, `*_lens`）。
- 统一日志接口：优先使用 `logger`（加上模块级 logger）而非 `print`，便于在分布式/多进程下管理输出等级与重定向；Markdown 日志建议抽象一个“小组件层”以避免重复拼接字符串。
- 将“多模态生成路径差异”（vLLM/paged/transformers）抽象为策略类或小型适配器，减少主流程上的 `if/elif` 分支。


**trainer（src/trainer/dapo_trainer.py）**

- 问题：核心函数体量偏大、职责混杂。
  - `_generate_and_score_completions` 同时负责：输入组装、生成、转文本、奖励计算、优势归一化、重放缓冲、日志组织，超过 300 行，阅读与维护成本高。
  - `_process_attention_metrics` 内既有 CPU/显存管理，又有度量计算与日志缓冲；异常捕获范围较大，难以定位具体失败点。
  - `_compute_loss` 既含 logprob/entropy/KL 的张量流，也包含策略剪裁、重要性采样、熵掩码、以及本次接入的 token 加权。

- 建议拆分：
  - 生成相关：提取 `decode_to_text(...)`、`prepare_mm_inputs(...)`、`slice_groupwise(...)` 等小函数；
  - 奖励相关：提取 `compute_groupwise_advantages(...)`、`apply_reward_weights(...)`；
  - 重放缓冲：独立 `replay_buffer_update(...)` 与 `replay_buffer_replace(...)`；
  - loss 相关：独立 `compute_coef_and_kl(...)`、`apply_entropy_mask(...)`、`apply_token_weights(...)`；
  - 注意力：独立 `build_token_weights_from_attentions(...)`（当前已以 util 实现）和 `push_attention_results(...)`；
  - 日志：独立 `emit_rollout(...)` 与 `emit_token_weights(...)`（已新增 dapo_logging 方法，建议 trainer 仅组织数据）。

- 命名与类型：
  - 局部变量建议对齐：`prompt_ids_list/completion_ids_list`（list）与 `prompt_ids/completion_ids`（padded tensor）尽量靠近使用处并注明形状；
  - `orig_size`/`tp_slice`/`tp_group` 等 vLLM 路径变量可加注释说明含义；
  - 补充函数签名的返回类型注解（如 `_generate_single_turn` 可标注元组的详细结构）。


**注意力与权重（src/utils/attention_metrics.py / attention_token_weights.py）**

- 已有较清晰的文档化数据流。建议：
  - `_collect_llm_attention_for_sample` 里 CPU/显存转移、row 拼接逻辑可拆分为两个小函数，当前函数偏长；
  - `_split_layers_to_segments` 与 `_compute_segment_metrics` 的早退与对齐分支较多，可通过辅助函数清晰化“对齐到 prompt_len”的处理；
  - `build_token_vgr_weights_for_batch` 返回的 `debug` 结构目前仅在开发调试时使用，若在生产中不需要，可增加开关避免冗余开销。


**奖励函数（src/rewards/attention_rewards.py）**

- `vgr_reward` 与 `vgr_hard_negative` 共享了“组内分位映射”的大部分逻辑，建议抽取公共部分（如 `groupwise_vgr_mapping(...)`），以减少重复与防止参数漂移；
- 建议将常量 `alpha_abs/beta_rel/eps` 作为函数参数并配默认值；
- 在 docstring 中明确“输入 completions 的组织方式（B*G 扁平）与 num_generations 的关系”，便于读者对齐张量形状。


**数据处理（src/data/）**

- `dataset_aokvqa.py` / `dataset_visrag_arxivqa.py` / `dataset_mmmupro.py` 中存在部分重复的文本清洗与格式化逻辑（如 `to_list/strip_choice_prefix/clean_choices`），建议抽到 `src/data/common.py`，避免分散维护；
- 建议在 README 中补充“DDM 的列定义与约定”表格（image/problem/solution 的规范、ChatML 拼装规则）。


**日志（src/utils/dapo_logging.py）**

- Markdown 输出组织较好。本次新增的 `emit_token_weights_logs` 已将统计信息压缩到表格展示。建议：
  - 考虑为 rollout/eval/weights 三者提供统一的标题结构与分隔符（如统一使用 ‘## Step/epoch’、‘### Section’），提升可读性。
  - 未来如需绘图，可在日志中缓存原始分布（如直方图的 bin），之后用 notebook 复现图形。


**单元测试/快速验证**

- 建议补充：
  - 一个"attention_metrics 的形状与 NaN 早退"测试（随机伪造张量，验证早退路径无异常）；
  - 一个"reward 权重切换"的简单测试（给定 early/regular，检查 step 不同时返回的权重字典差异）。


**小结**

当前代码在研究性与工程性之间取得了平衡：功能完整，指标清晰，日志可读。本建议聚焦于“拆分与解耦、统一日志与命名、抽取公共逻辑”，以便后续加入新模型/新奖励/新生成后端时能更低成本地演进。

